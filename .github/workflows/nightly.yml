name: Nightly Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: nightly-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate Version
        id: version
        run: |
          BASE_VERSION=$(node -p "require('./package.json').version")
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          DATE=$(date +'%Y%m%d')
          VERSION="${BASE_VERSION}-nightly.${DATE}.${SHORT_SHA}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # å…ˆæž„å»º Vite äº§ç‰©ï¼Œå…±äº«ç»™æ‰€æœ‰å¹³å°
  build-app:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Set version
        run: npm version ${{ needs.prepare.outputs.version }} --no-git-tag-version

      - name: Build app
        run: pnpm build
        env:
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Upload build output
        uses: actions/upload-artifact@v4
        with:
          name: app-build
          path: |
            out/
            package.json
          retention-days: 1

  build-mac:
    needs: [prepare, build-app]
    strategy:
      matrix:
        arch: [arm64, x64]
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build output
        uses: actions/download-artifact@v4
        with:
          name: app-build

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-${{ matrix.arch }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-${{ matrix.arch }}-pnpm-
          save-always: true

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/electron
            ~/Library/Caches/electron-builder
          key: ${{ runner.os }}-${{ matrix.arch }}-electron-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-${{ matrix.arch }}-electron-
          save-always: true

      - name: Cache electron-rebuild
        uses: actions/cache@v4
        with:
          path: .electron-rebuild-cache
          key: ${{ runner.os }}-${{ matrix.arch }}-rebuild-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-${{ matrix.arch }}-rebuild-
          save-always: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build macOS (${{ matrix.arch }})
        run: npx electron-builder --mac --${{ matrix.arch }} --publish never --config.mac.target=dmg --config.dmg.writeUpdateInfo=false

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac-${{ matrix.arch }}
          path: dist/*.dmg
          retention-days: 7

  build-windows:
    needs: [prepare, build-app]
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build output
        uses: actions/download-artifact@v4
        with:
          name: app-build

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-
          save-always: true

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: |
            ~/AppData/Local/electron/Cache
            ~/AppData/Local/electron-builder/Cache
          key: ${{ runner.os }}-electron-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-electron-
          save-always: true

      - name: Cache electron-rebuild
        uses: actions/cache@v4
        with:
          path: .electron-rebuild-cache
          key: ${{ runner.os }}-rebuild-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-rebuild-
          save-always: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Windows
        run: npx electron-builder --win --x64 --publish never --config.win.target=portable

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: dist/*portable*.exe
          retention-days: 7

  build-linux:
    needs: [prepare, build-app]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build output
        uses: actions/download-artifact@v4
        with:
          name: app-build

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-
          save-always: true

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-electron-
          save-always: true

      - name: Cache electron-rebuild
        uses: actions/cache@v4
        with:
          path: .electron-rebuild-cache
          key: ${{ runner.os }}-rebuild-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-rebuild-
          save-always: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Linux
        run: npx electron-builder --linux --x64 --publish never --config.linux.target=AppImage

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: dist/*.AppImage
          retention-days: 7

  release:
    needs: [prepare, build-mac, build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.AppImage" \) -exec cp {} release/ \;
          ls -la release/

      - name: Delete existing nightly releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # åˆ é™¤æ‰€æœ‰ -nightly åŽç¼€çš„ releaseï¼ˆä½¿ç”¨ JSON æ ¼å¼èŽ·å–å‡†ç¡®çš„ tag åï¼‰
          gh release list --limit 100 --json tagName -q '.[].tagName' | grep -E '\-nightly$' | while read tag; do
            echo "Deleting release: $tag"
            gh release delete "$tag" --yes --cleanup-tag || true
          done

      - name: Create nightly release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          BASE_VERSION=$(echo "$VERSION" | cut -d'-' -f1)
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA=$(echo "$COMMIT_SHA" | cut -c1-7)
          TAG="v${BASE_VERSION}-nightly"

          cat > notes.md << EOF
          ## ðŸŒ™ Nightly Build

          > âš ï¸ **è­¦å‘Š**: è¿™æ˜¯è‡ªåŠ¨æž„å»ºçš„å†…æµ‹ç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªå®Œæˆçš„åŠŸèƒ½å’Œå·²çŸ¥é—®é¢˜ã€‚

          **ç‰ˆæœ¬**: \`${VERSION}\`
          **æäº¤**: [\`${SHORT_SHA}\`](https://github.com/${{ github.repository }}/commit/${COMMIT_SHA})
          **æ¶ˆæ¯**: ${COMMIT_MSG}
          **æ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          ---

          ## ðŸ“¦ ä¸‹è½½

          | å¹³å° | æ–‡ä»¶ |
          |------|------|
          | macOS (Apple Silicon) | EnsoAI-${VERSION}-arm64.dmg |
          | macOS (Intel) | EnsoAI-${VERSION}.dmg |
          | Windows (x64) | EnsoAI-${VERSION}-portable.exe |
          | Linux (x64) | EnsoAI-${VERSION}.AppImage |

          > âš ï¸ **macOS ç”¨æˆ·æ³¨æ„**: ç”±äºŽåº”ç”¨æœªç­¾åï¼Œé¦–æ¬¡æ‰“å¼€å¯èƒ½æç¤º"å·²æŸå"ï¼Œè¯·åœ¨ç»ˆç«¯æ‰§è¡Œï¼š
          > \`\`\`bash
          > sudo xattr -dr com.apple.quarantine /Applications/EnsoAI.app
          > \`\`\`
          EOF

          gh release create "$TAG" \
            --title "Nightly Build (${SHORT_SHA})" \
            --notes-file notes.md \
            --prerelease \
            --target ${{ github.sha }} \
            release/*
